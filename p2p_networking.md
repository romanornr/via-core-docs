# P2P Networking Layer in Via L2 Bitcoin ZK-Rollup

## Executive Summary

After a comprehensive analysis of the Via L2 Bitcoin ZK-Rollup codebase, I have found **no evidence of a dedicated peer-to-peer (P2P) networking layer** for direct communication between distributed nodes. The system primarily relies on client-server communication patterns using REST APIs and JSON-RPC, with centralized coordination components managing the interactions between different node types.

## Analysis Methodology

The analysis involved examining key components of the Via L2 system that might potentially implement or utilize P2P networking:

1. **Core Node Components**: Examined directories like `core/node/`, focusing on consensus, node synchronization, and communication mechanisms.
2. **Verifier Network**: Analyzed the verifier coordination system in `via_verifier/node/via_verifier_coordinator/`.
3. **Prover System**: Investigated the prover gateway and related components in `prover/crates/bin/prover_fri_gateway/`.
4. **Data Availability**: Examined the data availability clients in `core/lib/da_client/` and `core/lib/via_da_clients/`.
5. **Mempool**: Checked for potential transaction gossip mechanisms in `core/lib/mempool/`.

## Key Findings

### 1. Verifier Network Communication

The Verifier Network uses a centralized coordinator with a REST API for communication:

- The `via_verifier_coordinator` implements a REST API server using the Axum framework.
- Verifiers communicate with the coordinator through HTTP endpoints like:
  - `/session/new` - Create a new session
  - `/session/` - Get session information
  - `/session/signature` - Submit or get signatures
  - `/session/nonce` - Submit or get nonces
- There is no direct P2P communication between verifiers; all communication is mediated through the coordinator.

```rust
// From via_verifier/node/via_verifier_coordinator/src/coordinator/api.rs
pub async fn start_coordinator_server(
    config: ViaVerifierConfig,
    master_connection_pool: ConnectionPool<Verifier>,
    btc_client: Arc<dyn BitcoinOps>,
    withdrawal_client: WithdrawalClient,
    mut stop_receiver: watch::Receiver<bool>,
) -> anyhow::Result<()> {
    let bind_address = config.bind_addr();
    let api = RestApi::new(
        config,
        master_connection_pool,
        btc_client,
        withdrawal_client,
    )?
    .into_router();

    let listener = tokio::net::TcpListener::bind(bind_address)
        .await
        .context("Cannot bind to the specified address")?;
    axum::serve(listener, api)
        // ...
}
```

### 2. Node Synchronization

The node synchronization system uses JSON-RPC for communication between nodes:

- The `MainNodeClient` trait in `core/node/node_sync/src/client.rs` defines methods for fetching data from the main node using RPC calls.
- External nodes fetch blocks and other data from the main node through this client.
- There is a warning message in `core/node/node_sync/src/en.rs` that mentions a future P2P synchronization mechanism:

```rust
tracing::warn!("\
    WARNING: this node is using ZKsync API synchronization, which will be deprecated soon. \
    Please follow this instruction to switch to p2p synchronization: \
    https://github.com/matter-labs/zksync-era/blob/main/docs/guides/external-node/09_decentralization.md");
```

However, this P2P synchronization mechanism does not appear to be implemented in the Via L2 codebase yet.

### 3. Consensus Mechanism

The consensus mechanism in `core/node/consensus/` does not use P2P networking:

- The main node is the only leader of the consensus, proposing all L2 blocks generated by the Statekeeper.
- External nodes can either run a consensus node or just fetch blocks from the main node using JSON-RPC.
- Communication is primarily client-server, not peer-to-peer.

### 4. Data Availability

The data availability system uses external services like Celestia:

- The `CelestiaClient` in `core/lib/via_da_clients/src/celestia/client.rs` interacts with the Celestia network through its RPC API.
- While Celestia itself is a P2P network, the Via L2 codebase doesn't implement the P2P networking layer itself.

```rust
// From core/lib/via_da_clients/src/celestia/client.rs
pub async fn new(celestia_conf: ViaCelestiaConfig) -> anyhow::Result<Self> {
    let client = Client::new(&celestia_conf.api_node_url, Some(&celestia_conf.auth_token))
        .await
        .map_err(|error| anyhow!("Failed to create a client: {}", error))?;

    // connection test
    let _info = client.p2p_info().await?;
    // ...
}
```

### 5. Prover System

The prover gateway in `prover/crates/bin/prover_fri_gateway/` uses HTTP requests for communication:

- The `ProverApiClient` in `prover/crates/bin/prover_fri_gateway/src/client.rs` uses reqwest to make HTTP requests.
- There is no P2P communication between provers.

## Conclusion

The Via L2 Bitcoin ZK-Rollup system does not currently implement a dedicated P2P networking layer for direct communication between distributed nodes. Instead, it relies on:

1. **Client-Server Architecture**: Most components use REST APIs or JSON-RPC for communication.
2. **Centralized Coordination**: Components like the verifier coordinator act as central points for managing communication between nodes.
3. **External Data Availability**: The system leverages external data availability services like Celestia, which themselves use P2P networking.

There is a mention of a future P2P synchronization mechanism in the codebase, but it does not appear to be implemented yet. The current architecture follows a more traditional client-server model rather than a decentralized P2P approach.

## Future Considerations

The warning message about a future P2P synchronization mechanism suggests that the system may evolve to incorporate more P2P networking in the future. This would potentially increase decentralization and reduce reliance on centralized components. However, as of the current codebase analysis, such a P2P layer is not present.